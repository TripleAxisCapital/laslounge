<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="A tasteful, minimalist gallery for elegant erotic art. Adults 18+ only." />
  <meta name="robots" content="noimageindex,nosnippet" />
  <meta http-equiv="Permissions-Policy" content="interest-cohort=()" />
  <title>Maison — Elegant Gallery (18+)</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Ccircle cx='32' cy='32' r='30' fill='black'/%3E%3C/svg%3E">
  <style>
    :root{
      --ink:#0b0b0b; --ink-2:#1b1b1b; --muted:#6b7280; --line:rgba(0,0,0,.10);
      --bg:#fff; --bg-2:#f7f7f7; --accent:#111; --soft:rgba(0,0,0,.06);
      --radius:18px; --radius-xs:10px; --shadow:0 10px 30px rgba(0,0,0,.08);
      --blur:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%; background:var(--bg); color:var(--ink); -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;}
    body{margin:0; font:16px/1.5 -apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display",Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}

    /* Header */
    header{
      position:sticky; top:0; z-index:30;
      backdrop-filter:saturate(180%) blur(var(--blur));
      background:linear-gradient(to bottom, rgba(255,255,255,.75), rgba(255,255,255,.55) 40%, transparent);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:14px 20px; display:flex; gap:14px; align-items:center; justify-content:space-between;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:600; letter-spacing:.02em;}
    .brand-logo{width:28px; height:28px; border-radius:999px; background:#000;}
    .pill{
      display:flex; align-items:center; gap:10px; border:1px solid var(--line);
      background:rgba(255,255,255,.65); border-radius:999px; padding:8px 12px; box-shadow:var(--shadow);
    }
    .pill input{
      border:0; outline:0; background:transparent; font:inherit; width:220px; color:var(--ink);
    }
    .btn, button{
      border:1px solid var(--line); background:#fff; border-radius:999px; padding:10px 16px; cursor:pointer;
      font-weight:600; transition:transform .2s ease, box-shadow .2s ease, opacity .2s ease;
      box-shadow:0 6px 20px rgba(0,0,0,.06);
    }
    .btn:hover{transform:translateY(-1px)}
    .btn[aria-pressed="true"]{background:#111; color:#fff;}

    /* Toolbar */
    .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .seg{
      display:flex; border:1px solid var(--line); border-radius:999px; padding:4px; background:rgba(255,255,255,.7);
    }
    .seg button{
      border:0; background:transparent; border-radius:999px; padding:8px 14px; font-weight:600; color:var(--muted);
    }
    .seg button[aria-pressed="true"]{background:#111; color:#fff;}

    /* Grid (Apple-clean masonry via CSS columns) */
    main{max-width:1200px; margin:18px auto 80px; padding:0 20px;}
    .masonry{column-gap:18px;}
    @media (min-width:640px){ .masonry{column-count:2;} }
    @media (min-width:980px){ .masonry{column-count:3;} }
    @media (min-width:1280px){ .masonry{column-count:4;} }

    .tile{break-inside:avoid; display:block; margin:0 0 18px; position:relative; border-radius:var(--radius); overflow:hidden; background:var(--bg-2); border:1px solid var(--line);}
    .tile .ph{
      aspect-ratio:2/3; background:linear-gradient(135deg, #eee, #fff); filter:saturate(.9) contrast(.98);
      animation:pulse 1.2s ease-in-out infinite;
    }
    @keyframes pulse{50%{opacity:.65}}
    .tile img{
      width:100%; height:auto; display:block; opacity:0; transform:translateY(6px) scale(1.01);
      transition:opacity .45s ease, transform .6s cubic-bezier(.2,.8,.2,1);
    }
    .tile.loaded img{opacity:1; transform:none;}
    .tile .meta{
      position:absolute; inset:auto 8px 8px 8px; display:flex; justify-content:space-between; align-items:center;
      background:linear-gradient(to top, rgba(0,0,0,.32), rgba(0,0,0,0)); color:#fff; padding:40px 8px 8px; border-radius:0 0 var(--radius) var(--radius);
      opacity:0; transition:opacity .25s ease;
    }
    .tile:hover .meta{opacity:1}
    .heart{
      width:34px; height:34px; border-radius:999px; display:grid; place-items:center; background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.25);
      backdrop-filter:blur(6px);
    }
    .heart svg{width:18px; height:18px; fill:none; stroke:#fff; stroke-width:2;}
    .heart[data-on="true"] svg{fill:#fff; stroke:#fff}

    /* Lightbox */
    .lightbox{
      position:fixed; inset:0; z-index:40; display:none; place-items:center; background:rgba(0,0,0,.85);
      backdrop-filter:blur(4px);
    }
    .lightbox.on{display:grid; animation:fadeIn .24s ease;}
    @keyframes fadeIn{from{opacity:0} to{opacity:1}}
    .viewer{
      position:relative; max-width:96vw; max-height:92vh; border-radius:20px; overflow:hidden; background:#000; box-shadow:0 20px 80px rgba(0,0,0,.6);
    }
    .viewer img{display:block; max-width:100%; max-height:92vh; width:auto; height:auto; margin:auto; user-select:none;}
    .ui{
      position:absolute; inset:auto 0 0 0; display:flex; justify-content:space-between; align-items:center;
      padding:10px 14px; color:#fff; background:linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0));
    }
    .ui .controls{display:flex; gap:8px; align-items:center;}
    .ghost-btn{
      display:grid; place-items:center; width:40px; height:40px; border-radius:999px; border:1px solid rgba(255,255,255,.3);
      background:rgba(255,255,255,.12); cursor:pointer;
    }
    .ghost-btn:hover{background:rgba(255,255,255,.2)}
    .index{font-weight:600; opacity:.9}

    /* Age Gate */
    .gate{
      position:fixed; inset:0; z-index:50; display:grid; place-items:center; background:radial-gradient(1200px 800px at 50% 30%, #ffffff, #f2f2f2 60%, #eaeaea 100%);
    }
    .gate-inner{position:relative; width:min(1100px, 92vw); height:min(700px, 70vh); perspective:1200px;}
    .door{
      position:absolute; top:0; width:50%; height:100%; background:linear-gradient(180deg, #fefefe, #f5f5f5);
      border:1px solid var(--line); box-shadow:0 40px 80px rgba(0,0,0,.15) inset, 0 10px 30px rgba(0,0,0,.08);
      will-change:transform;
    }
    .door.left{left:0; border-radius:24px 0 0 24px; transform-origin:left center;}
    .door.right{right:0; border-radius:0 24px 24px 0; transform-origin:right center;}
    .arch{
      position:absolute; inset:18px; border-radius:22px; border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(0,0,0,.03), transparent 30%);
    }
    .crest{
      position:absolute; top:-70px; left:50%; transform:translateX(-50%);
      background:#111; color:#fff; padding:10px 16px; border-radius:999px; letter-spacing:.12em; font-weight:700; font-size:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.2);
    }
    .gate-copy{
      position:absolute; inset:0; display:grid; place-items:center; text-align:center; padding:20px; pointer-events:none;
    }
    .gate-title{font-family:ui-serif,Georgia,Times,serif; font-size:clamp(28px, 6vw, 56px); letter-spacing:.02em; font-weight:600;}
    .gate-sub{color:var(--muted); max-width:720px; margin:12px auto 18px;}
    .gate-actions{display:flex; gap:10px; justify-content:center; pointer-events:auto;}
    .gate .fine{font-size:12px; color:#777; margin-top:6px;}

    .gate.open .door.left{ animation:openL 1.2s cubic-bezier(.2,.8,.2,1) forwards; }
    .gate.open .door.right{ animation:openR 1.2s cubic-bezier(.2,.8,.2,1) forwards; }
    .gate.open{ animation:gateFade .8s ease .9s forwards; }
    @keyframes openL{ to{ transform:translateX(-52%) rotateY(-22deg); opacity:.7 } }
    @keyframes openR{ to{ transform:translateX(52%) rotateY(22deg); opacity:.7 } }
    @keyframes gateFade{ to{ opacity:0; visibility:hidden } }

    /* Helper */
    .hidden{display:none !important}

    /* Footer */
    footer{max-width:1200px; margin:40px auto 80px; padding:0 20px; color:#6b7280; font-size:13px;}
    footer .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; border-top:1px solid var(--line); padding-top:16px;}
  </style>
</head>
<body>

  <!-- AGE GATE -->
  <div id="ageGate" class="gate" role="dialog" aria-modal="true" aria-label="Age Verification">
    <div class="gate-inner">
      <div class="crest">MAISON</div>
      <div class="door left"><div class="arch"></div></div>
      <div class="door right"><div class="arch"></div></div>
      <div class="gate-copy">
        <div>
          <div class="gate-title">Enter if you are 18+</div>
          <p class="gate-sub">This collection features tasteful, artistic imagery intended for adults. By entering, you confirm you are at least 18 years old (or the age of majority in your region).</p>
          <div class="gate-actions">
            <button id="enter" class="btn" style="background:#111;color:#fff;">Enter</button>
            <button id="leave" class="btn" onclick="location.href='https://www.google.com'">Leave</button>
          </div>
          <div class="fine">You’ll only see this once per device for 30 days.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true"></div>
        <span>Maison</span>
      </div>
      <div class="toolbar">
        <div class="pill" role="search">
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M10.5 3.5a7 7 0 1 1 0 14 7 7 0 0 1 0-14Zm0 2a5 5 0 1 0 0 10 5 5 0 0 0 0-10Zm9.2 14.8-4.1-4.1" stroke="#111" stroke-width="1.8" fill="none" stroke-linecap="round"/></svg>
          <input id="search" placeholder="Search by name…" aria-label="Search photos"/>
        </div>
        <div class="seg" role="tablist" aria-label="View">
          <button id="tab-all" role="tab" aria-pressed="true">All</button>
          <button id="tab-fav" role="tab" aria-pressed="false">Favorites</button>
          <button id="tab-slide" role="tab" aria-pressed="false">Slideshow</button>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main>
    <section id="grid" class="masonry" aria-live="polite"></section>
  </main>

  <!-- LIGHTBOX -->
  <div id="lightbox" class="lightbox" aria-hidden="true" aria-label="Image viewer">
    <div class="viewer" id="viewer" tabindex="-1">
      <img id="viewerImg" alt="Artwork" />
      <div class="ui">
        <div class="index" id="lbIndex">1 / 1</div>
        <div class="controls">
          <button class="ghost-btn" id="prev" title="Previous (←)">
            <svg width="18" height="18" viewBox="0 0 24 24"><path d="M15 5 8 12l7 7" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <button class="ghost-btn" id="next" title="Next (→)">
            <svg width="18" height="18" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <button class="ghost-btn" id="toggleFS" title="Fullscreen (F)">
            <svg width="18" height="18" viewBox="0 0 24 24"><path d="M8 3H3v5M21 8V3h-5M3 16v5h5M16 21h5v-5" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
          </button>
          <button class="ghost-btn" id="play" title="Play/Pause (Space)">
            <svg id="playIcon" width="18" height="18" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" fill="#fff"/></svg>
          </button>
          <button class="ghost-btn" id="close" title="Close (Esc)">
            <svg width="18" height="18" viewBox="0 0 24 24"><path d="M5 5l14 14M19 5 5 19" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer>
    <div class="row">
      <div>© <span id="year"></span> Maison. All imagery © their respective owners. Adults 18+.</div>
      <div style="display:flex; gap:8px;">
        <a class="btn" href="#" id="downloadManifest">Export manifest</a>
        <a class="btn" href="#" id="how">How to add photos</a>
      </div>
    </div>
  </footer>

  <script>
  /* =========================
     CONFIG (edit if desired)
     ========================= */
  const CONFIG = {
    galleryPath: 'gallery/',            // put your images in /gallery/
    useManifestFirst: true,             // if gallery/manifest.json exists, it will be used
    guessPattern: 'img-',               // base name for auto-guessing
    startIndex: 1, endIndex: 999,       // range to probe when auto-guessing
    zeroPad: 4,                         // img-0001.jpg
    exts: ['webp','jpg','jpeg','png','avif'],
    breakAfterMisses: 25,               // stop guessing after this many consecutive 404s
    rememberGateDays: 30,
    slideDelayMs: 4000
  };

  /* =========================
     AGE GATE
     ========================= */
  const gate = document.getElementById('ageGate');
  const enterBtn = document.getElementById('enter');
  const LEAVE_URL = 'https://www.google.com';
  function gateOk(){
    const t = localStorage.getItem('maison.age.ok');
    if(!t) return false;
    try{
      const o = JSON.parse(t);
      return Date.now() < o.exp;
    }catch(e){ return false; }
  }
  function setGateOK(){
    const exp = Date.now() + CONFIG.rememberGateDays*24*60*60*1000;
    localStorage.setItem('maison.age.ok', JSON.stringify({exp}));
  }
  if(gateOk()){ gate.style.display='none'; } else {
    // keep visible
  }
  enterBtn?.addEventListener('click', () => {
    setGateOK();
    gate.classList.add('open');
    setTimeout(()=>{ gate.style.display='none'; }, 1300);
  });
  document.getElementById('leave')?.addEventListener('click', () => location.href = LEAVE_URL);

  /* =========================
     UTIL
     ========================= */
  const $ = sel => document.querySelector(sel);
  const grid = $('#grid');
  const searchInput = $('#search');
  const yearSpan = $('#year'); yearSpan.textContent = new Date().getFullYear();
  const favKey = 'maison.favs';
  let favs = new Set(JSON.parse(localStorage.getItem(favKey) || '[]'));
  const saveFavs = () => localStorage.setItem(favKey, JSON.stringify([...favs]));
  const pad = (n, z=CONFIG.zeroPad) => String(n).padStart(z,'0');
  const qsImages = new URLSearchParams(location.search).get('images');
  const ownerMode = new URLSearchParams(location.search).get('owner') === '1';

  /* =========================
     IMAGE SOURCE LOADING
     ========================= */
  async function loadManifest(){
    if(!CONFIG.useManifestFirst) return null;
    try{
      const r = await fetch(CONFIG.galleryPath + 'manifest.json', {cache:'no-cache'});
      if(!r.ok) return null;
      const j = await r.json();
      const images = Array.isArray(j.images) ? j.images : j;
      return images.filter(Boolean);
    }catch(e){ return null; }
  }

  async function urlExists(url){
    try{
      const r = await fetch(url, {method:'HEAD'});
      return r.ok;
    }catch(e){
      // fallback by trying to load image object (slower)
      return new Promise(res=>{
        const im = new Image(); im.onload=()=>res(true); im.onerror=()=>res(false); im.src=url;
      });
    }
  }

  async function guessImages(){
    const found = [];
    let misses=0;
    outer: for(let i=CONFIG.startIndex; i<=CONFIG.endIndex; i++){
      let hit=false;
      for(const ext of CONFIG.exts){
        const url = `${CONFIG.galleryPath}${CONFIG.guessPattern}${pad(i)}.${ext}`;
        /* eslint-disable no-await-in-loop */
        if(await urlExists(url)){ found.push(url); hit=true; break; }
      }
      if(!hit){ misses++; if(misses>=CONFIG.breakAfterMisses) break outer; }
      else { misses=0; }
    }
    return found;
  }

  function parseQSImages(){
    if(!qsImages) return null;
    return qsImages.split(',').map(s=>s.trim()).filter(Boolean);
  }

  async function loadImagesList(){
    const fromQS = parseQSImages();
    if(fromQS?.length) return fromQS;
    const man = await loadManifest();
    if(man?.length) return man;
    const guessed = await guessImages();
    return guessed;
  }

  /* =========================
     RENDER GRID
     ========================= */
  let allPhotos = [];
  let viewMode = 'all'; // 'all' | 'fav' | 'slide'
  async function initGrid(){
    const list = await loadImagesList();
    if(!list.length){
      grid.innerHTML = `
        <div class="tile" style="padding:24px; text-align:center;">
          <div style="font-weight:600; font-size:18px; margin-bottom:6px;">No images found</div>
          <div style="color:#6b7280">Add files to <code>${CONFIG.galleryPath}</code> as <code>${CONFIG.guessPattern}${pad(1)}.jpg</code> … or create <code>gallery/manifest.json</code>.</div>
        </div>`;
      return;
    }
    allPhotos = list.map((src,i)=>({id:String(i+1), src, name: src.split('/').pop() || `Image ${i+1}`}));
    render();
  }

  function render(){
    const q = (searchInput.value || '').trim().toLowerCase();
    const isFav = p => favs.has(p.src);
    const filtered = allPhotos.filter(p=>{
      if(viewMode==='fav' && !isFav(p)) return false;
      if(q && !p.name.toLowerCase().includes(q)) return false;
      return true;
    });
    grid.innerHTML = '';
    for(const p of filtered){
      const tile = document.createElement('a');
      tile.href = p.src;
      tile.className = 'tile';
      tile.setAttribute('data-src', p.src);
      tile.setAttribute('data-id', p.id);
      tile.setAttribute('aria-label', 'View image');
      tile.addEventListener('click', e => { e.preventDefault(); openLightboxBySrc(p.src); });

      const ph = document.createElement('div'); ph.className='ph'; tile.appendChild(ph);
      const img = document.createElement('img'); img.alt = p.name.replace(/[-_]/g,' ').replace(/\.[a-z0-9]+$/i,'');
      tile.appendChild(img);

      const meta = document.createElement('div'); meta.className='meta';
      const cap = document.createElement('div'); cap.textContent = img.alt || 'Artwork';
      const heart = document.createElement('button'); heart.className='heart'; heart.title='Favorite'; heart.type='button';
      heart.setAttribute('aria-pressed', String(favs.has(p.src)));
      heart.setAttribute('data-on', String(favs.has(p.src)));
      heart.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 21s-7.5-4.35-9.3-8.76C1.6 9.1 3.25 6 6.4 6c1.8 0 3.05.96 3.6 1.77C10.55 6.96 11.8 6 13.6 6c3.15 0 4.8 3.1 3.7 6.24C19.5 16.65 12 21 12 21z"/></svg>';
      heart.addEventListener('click', (e)=>{
        e.stopPropagation(); e.preventDefault();
        if(favs.has(p.src)) favs.delete(p.src); else favs.add(p.src);
        heart.setAttribute('data-on', String(favs.has(p.src)));
        heart.setAttribute('aria-pressed', String(favs.has(p.src)));
        saveFavs();
        if(viewMode==='fav') render();
      });

      meta.appendChild(cap); meta.appendChild(heart);
      tile.appendChild(meta);
      grid.appendChild(tile);

      lazyLoad(img, p.src, tile);
    }
  }

  function lazyLoad(img, src, tile){
    const io = new IntersectionObserver(entries=>{
      for(const ent of entries){
        if(ent.isIntersecting){
          io.unobserve(img);
          img.src = src;
          img.loading = 'lazy';
          img.decoding = 'async';
          img.addEventListener('load', ()=> tile.classList.add('loaded'), {once:true});
          img.addEventListener('error', ()=> { tile.remove(); }, {once:true});
        }
      }
    }, {rootMargin:'400px 0px'});
    io.observe(img);
  }

  /* =========================
     LIGHTBOX
     ========================= */
  const lb = $('#lightbox');
  const viewer = $('#viewer');
  const viewerImg = $('#viewerImg');
  const lbIndex = $('#lbIndex');
  const prevBtn = $('#prev'), nextBtn = $('#next'), closeBtn = $('#close'), fsBtn = $('#toggleFS'), playBtn = $('#play');
  let currentIndex = 0;
  let slideTimer = null;

  function openLightboxBySrc(src){
    currentIndex = allPhotos.findIndex(p=>p.src===src);
    if(currentIndex<0) currentIndex = 0;
    updateLightbox();
    lb.classList.add('on'); lb.setAttribute('aria-hidden','false');
    viewer.focus();
  }
  function updateLightbox(){
    const p = allPhotos[currentIndex];
    viewerImg.style.opacity='0';
    viewerImg.src = p.src;
    viewerImg.onload = ()=>{
      viewerImg.style.transition='opacity .35s ease, transform .35s ease';
      viewerImg.style.opacity='1'; viewerImg.style.transform='none';
    };
    lbIndex.textContent = `${currentIndex+1} / ${allPhotos.length}`;
  }
  function closeLightbox(){
    lb.classList.remove('on'); lb.setAttribute('aria-hidden','true');
    stopSlide();
  }
  function next(){ currentIndex=(currentIndex+1)%allPhotos.length; updateLightbox(); }
  function prev(){ currentIndex=(currentIndex-1+allPhotos.length)%allPhotos.length; updateLightbox(); }

  function toggleFS(){
    if(!document.fullscreenElement){ viewer.requestFullscreen?.(); }
    else { document.exitFullscreen?.(); }
  }

  function startSlide(){
    if(slideTimer) return;
    playBtn.title='Pause (Space)';
    document.getElementById('playIcon').outerHTML = '<svg id="playIcon" width="18" height="18" viewBox="0 0 24 24"><path d="M7 5h4v14H7zM13 5h4v14h-4z" fill="#fff"/></svg>';
    slideTimer = setInterval(next, CONFIG.slideDelayMs);
  }
  function stopSlide(){
    if(slideTimer){ clearInterval(slideTimer); slideTimer=null; }
    playBtn.title='Play (Space)';
    document.getElementById('playIcon').outerHTML = '<svg id="playIcon" width="18" height="18" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" fill="#fff"/></svg>';
  }
  function toggleSlide(){ slideTimer ? stopSlide() : startSlide(); }

  prevBtn.addEventListener('click', prev);
  nextBtn.addEventListener('click', next);
  closeBtn.addEventListener('click', closeLightbox);
  fsBtn.addEventListener('click', toggleFS);
  playBtn.addEventListener('click', toggleSlide);
  lb.addEventListener('click', (e)=>{ if(e.target===lb) closeLightbox(); });

  // Keyboard
  window.addEventListener('keydown', (e)=>{
    if(lb.classList.contains('on')){
      if(e.key==='Escape') closeLightbox();
      else if(e.key==='ArrowRight') next();
      else if(e.key==='ArrowLeft') prev();
      else if(e.key.toLowerCase()==='f') toggleFS();
      else if(e.code==='Space'){ e.preventDefault(); toggleSlide(); }
      else if(e.key.toLowerCase()==='l'){ favs.add(allPhotos[currentIndex].src); saveFavs(); }
    }
  });

  // Touch swipe
  (function addSwipe(el){
    let x0=null, y0=null;
    el.addEventListener('touchstart', e=>{ const t=e.touches[0]; x0=t.clientX; y0=t.clientY; },{passive:true});
    el.addEventListener('touchend', e=>{
      if(x0===null) return;
      const t=e.changedTouches[0]; const dx=t.clientX - x0; const dy=t.clientY - y0;
      if(Math.abs(dx)>50 && Math.abs(dx)>Math.abs(dy)) (dx<0?next:prev)();
      x0=y0=null;
    },{passive:true});
  })(viewer);

  /* =========================
     CONTROLS
     ========================= */
  $('#tab-all').addEventListener('click', e=>{ setSeg('all', e.target); });
  $('#tab-fav').addEventListener('click', e=>{ setSeg('fav', e.target); });
  $('#tab-slide').addEventListener('click', e=>{ setSeg('slide', e.target); });

  function setSeg(mode, btn){
    viewMode = mode;
    document.querySelectorAll('.seg button').forEach(b=>b.setAttribute('aria-pressed','false'));
    btn.setAttribute('aria-pressed','true');
    if(mode==='slide'){
      // Open first image in lightbox and auto-play
      openLightboxBySrc(allPhotos[0]?.src);
      startSlide();
    }else{
      stopSlide();
      render();
    }
  }

  searchInput.addEventListener('input', ()=>render());

  /* =========================
     OWNER HELPERS
     ========================= */
  $('#how').addEventListener('click', (e)=>{
    e.preventDefault();
    alert([
      'Add images to /gallery/ (recommended names: img-0001.jpg, img-0002.jpg, …).',
      '— OR — create /gallery/manifest.json with: { "images": ["gallery/photo1.jpg","gallery/photo2.png"] }',
      'Optionally pass ?images=URL1,URL2 in the page URL for testing.',
      'Favorites are saved locally. Keyboard: ← → Esc F Space.'
    ].join('\n'));
  });

  $('#downloadManifest').addEventListener('click', (e)=>{
    e.preventDefault();
    if(!allPhotos.length){ alert('No images loaded yet.'); return; }
    const data = { images: allPhotos.map(p=>p.src) };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='manifest.json'; a.click();
    URL.revokeObjectURL(url);
  });

  /* =========================
     SW (inline, for caching)
     ========================= */
  if('serviceWorker' in navigator){
    const swCode = `
      const CACHE='maison-v1';
      self.addEventListener('install',e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./']))); self.skipWaiting(); });
      self.addEventListener('activate',e=>{ e.waitUntil(self.clients.claim()); });
      self.addEventListener('fetch',e=>{
        const url = new URL(e.request.url);
        // Cache-first for images
        if(/\\.(png|jpe?g|webp|avif)$/i.test(url.pathname)){
          e.respondWith(caches.open(CACHE).then(async cache=>{
            const hit = await cache.match(e.request); if(hit) return hit;
            const res = await fetch(e.request); if(res.ok) cache.put(e.request,res.clone()); return res;
          }));
        }
      });
    `;
    const swBlob = new Blob([swCode], {type:'text/javascript'});
    const swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl).catch(()=>{});
  }

  /* =========================
     START
     ========================= */
  initGrid();

  </script>
</body>
</html>
