<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="color-scheme" content="dark light" />
<title>Eros Noir — Tasteful Erotic Art</title>
<meta name="description" content="A refined, Apple-style gallery for tasteful adult erotic art.">
<meta name="theme-color" content="#0b0b0b" />
<style>
/* ============  RESET + TOKENS  ============ */
*,*::before,*::after{box-sizing:border-box}
:root{
  --ink:#0b0b0b; --ink-2:#222; --ink-3:#555;
  --paper:#ffffff; --paper-2:#fafafa; --paper-3:#f2f2f2;
  --line:rgba(0,0,0,.08);
  --shadow: 0 6px 30px rgba(0,0,0,.10), 0 2px 10px rgba(0,0,0,.06);
  --radius:20px; --radius-sm:14px; --radius-xs:10px;
  --pad-x: clamp(16px, 3vw, 28px);
  --gap: 16px; --gap-lg: 20px;
  --chip: 34px;
  --glass: blur(10px) saturate(1.1);
  --col-gap: 18px;
  --focus: 0 0 0 3px rgba(0,169,255,.35);
}
@media (prefers-color-scheme:dark){
  :root{
    --ink:#eaeaea; --ink-2:#cfcfcf; --ink-3:#9c9c9c;
    --paper:#0b0b0b; --paper-2:#111; --paper-3:#171717;
    --line:rgba(255,255,255,.10);
    --shadow: 0 10px 40px rgba(0,0,0,.45), 0 4px 16px rgba(0,0,0,.35);
  }
}
html,body{height:100%}
body{
  margin:0; color:var(--ink); background:var(--paper);
  font: 16px/1.45 -apple-system, BlinkMacSystemFont, "SF Pro Text","SF Pro Display", Inter, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, "Segoe UI Emoji", "Segoe UI Symbol";
  -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
}
a{color:inherit; text-decoration:none}
button{font:inherit; color:inherit}
img{display:block; max-width:100%; height:auto}

/* ============  AGE GATE  ============ */
.gate-overlay{
  position:fixed; inset:0; z-index:9999; display:grid; place-items:center;
  background:
    radial-gradient(1000px 600px at 50% 0%, rgba(255,255,255,.06), transparent 60%),
    radial-gradient(1200px 800px at 50% 100%, rgba(0,0,0,.60), rgba(0,0,0,.85));
  backdrop-filter: blur(6px);
}
.gate{
  position:relative; width:min(92vw, 980px); aspect-ratio:16/9;
  border-radius: var(--radius); overflow:hidden;
  box-shadow: 0 30px 100px rgba(0,0,0,.55);
  perspective: 1600px; transform-style: preserve-3d;
}
.door{
  position:absolute; inset:0; display:flex; width:50%; height:100%;
  background:
    linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,0)),
    linear-gradient(90deg, rgba(255,255,255,.10), rgba(255,255,255,0)),
    linear-gradient(180deg, #222 0%, #000 100%);
  outline:1px solid rgba(255,255,255,.08);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
  transform-origin:left center;
  transition: transform 1.2s cubic-bezier(.2,.8,.2,1);
}
.door.right{
  left:50%; transform-origin:right center;
  background:
    linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,0)),
    linear-gradient(-90deg, rgba(255,255,255,.10), rgba(255,255,255,0)),
    linear-gradient(180deg, #222 0%, #000 100%);
}
.gate.open .door.left{ transform: rotateY(-100deg) translateZ(.001px);}
.gate.open .door.right{ transform: rotateY(100deg) translateZ(.001px);}

.gate-sign{
  position:absolute; inset:0; display:grid; place-items:center; text-align:center;
  padding: clamp(18px, 3vw, 28px);
}
.gate-card{
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
  backdrop-filter: var(--glass);
  border-radius: var(--radius); border:1px solid rgba(255,255,255,.18);
  box-shadow: var(--shadow);
  width:min(92%,680px); padding: clamp(22px, 3vw, 36px);
  color:#fff;
}
.gate-card h1{
  margin:0 0 6px; font-weight:700; letter-spacing:.2px;
  font-size: clamp(26px, 4.2vw, 40px);
}
.gate-card p{margin:.4rem 0 1.2rem; color:rgba(255,255,255,.85)}
.actions{display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:10px}
.btn{
  appearance:none; border:1px solid rgba(255,255,255,.25);
  padding: 12px 18px; border-radius: 999px; background:rgba(255,255,255,.06);
  cursor:pointer; transition: transform .08s ease, border-color .2s ease, background .2s ease;
}
.btn:focus-visible{outline:none; box-shadow: var(--focus)}
.btn:hover{background:rgba(255,255,255,.12)}
.btn.primary{border-color: rgba(0,170,255,.6); background:linear-gradient(180deg, rgba(0,170,255,.35), rgba(0,170,255,.18))}
.remember{display:flex; gap:10px; align-items:center; justify-content:center; margin-top:10px; opacity:.9}
.remember input{width:16px; height:16px}

/* Blur-in for site after gate opens */
@keyframes blurIn{from{filter:blur(18px); opacity:0} to{filter:blur(0); opacity:1}}
.site-root{opacity:0}
.site-root.ready{animation: blurIn .6s ease forwards .3s}

/* ============  HEADER  ============ */
header{
  position:sticky; top:0; z-index:50;
  backdrop-filter: saturate(1.3) blur(10px);
  background: color-mix(in oklab, var(--paper) 80%, transparent);
  border-bottom:1px solid var(--line);
}
.header-inner{
  display:flex; align-items:center; gap:12px; justify-content:space-between;
  padding: 10px var(--pad-x);
}
.brand{
  display:flex; align-items:baseline; gap:10px; line-height:1;
}
.brand .logo{
  font-weight:700; letter-spacing:.3px;
  font-size: clamp(22px, 3vw, 28px);
}
.brand .tag{font-size:12px; color:var(--ink-3); letter-spacing:.2px}

.tools{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
.icon-btn{
  height:38px; min-width:38px; padding:0 12px; border-radius:999px; display:inline-flex; align-items:center; gap:8px; justify-content:center;
  border:1px solid var(--line); background:var(--paper-2); cursor:pointer;
}
.icon-btn:hover{background:var(--paper-3)}
.icon{width:18px; height:18px; display:inline-block}
input[type="search"]{
  height:38px; min-width: 220px; border-radius: 999px; border:1px solid var(--line);
  padding:0 14px; background:var(--paper-2); color:inherit;
}
select, .density{
  height:38px; border:1px solid var(--line); border-radius:999px; background:var(--paper-2); padding:0 12px;
}

/* ============  CONTROLS  ============ */
.controls{
  padding: 12px var(--pad-x) 0; display:flex; align-items:center; gap:10px; flex-wrap:wrap;
}
.chips{display:flex; gap:10px; flex-wrap:wrap}
.chip{
  height:var(--chip); padding:0 14px; border-radius:999px; border:1px solid var(--line);
  background:var(--paper-2); display:inline-flex; align-items:center; gap:8px; cursor:pointer;
}
.chip[aria-pressed="true"]{outline:1px solid rgba(0,170,255,.45); box-shadow:0 0 0 3px rgba(0,170,255,.15)}
.count{margin-left:auto; color:var(--ink-3); font-size:13px}

/* ============  GALLERY  ============ */
main{padding: 10px var(--pad-x) 60px}
.gallery{
  column-gap: var(--col-gap);
  columns: 1;
}
@media (min-width:520px){ .gallery{columns: 2}}
@media (min-width:840px){ .gallery{columns: 3}}
@media (min-width:1200px){ .gallery{columns: 4}}
@media (min-width:1600px){ .gallery{columns: 5}}
.dense-0 .gallery{columns: 2}
.dense-1 .gallery{columns: 3}
.dense-2 .gallery{columns: 4}
figure{
  break-inside: avoid; margin:0 0 var(--col-gap) 0; border-radius: var(--radius-sm);
  overflow:hidden; border:1px solid var(--line); background:var(--paper-2); box-shadow: var(--shadow);
  transform: translateZ(0); opacity:0; translate: 0 6px; transition: opacity .5s ease, translate .5s ease;
}
figure.visible{opacity:1; translate:0 0}
figure img{width:100%; height:auto; display:block; background:var(--paper-3); aspect-ratio: 3/4; object-fit: cover}
figcaption{
  padding:10px 12px; font-size:12px; color:var(--ink-3); display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.card-actions{display:flex; gap:8px; align-items:center}
.icon-link{display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:999px; border:1px solid var(--line); background:var(--paper-3)}
.icon-link:hover{background:var(--paper-2)}

/* ============  LIGHTBOX  ============ */
.lightbox{
  position:fixed; inset:0; z-index:60; display:none; grid-template-rows: 1fr auto;
  background: rgba(0,0,0,.88); backdrop-filter: blur(6px);
}
.lightbox.open{display:grid}
.viewer{display:grid; place-items:center; min-height:0; position:relative}
.viewer img{max-width:100%; max-height:100%; object-fit:contain; opacity:0; transition:opacity .24s ease}
.viewer img.ready{opacity:1}
.lb-controls{
  display:flex; align-items:center; justify-content:center; gap:10px; padding: 12px var(--pad-x);
  border-top:1px solid rgba(255,255,255,.12); background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.12));
}
.lb-btn{
  height:40px; min-width:40px; padding:0 14px; border-radius:999px; border:1px solid rgba(255,255,255,.25);
  background:rgba(255,255,255,.06); color:#fff; display:inline-flex; align-items:center; gap:8px; cursor:pointer;
}
.lb-btn:hover{background:rgba(255,255,255,.12)}
.lb-info{color:#fff; opacity:.8; font-size:13px; margin-left:auto; margin-right:auto; text-align:center}
.lb-close{position:absolute; top:14px; right:14px}
.lb-arrow{
  position:absolute; top:50%; translate:0 -50%; width:52px; height:52px; border-radius:999px; border:1px solid rgba(255,255,255,.25);
  background:rgba(255,255,255,.06); display:grid; place-items:center; cursor:pointer;
}
.lb-arrow:hover{background:rgba(255,255,255,.12)}
.lb-arrow.left{left:14px}
.lb-arrow.right{right:14px}

/* ============  FOOTER  ============ */
footer{
  padding: 40px var(--pad-x) 80px; color:var(--ink-3); font-size:13px; text-align:center; border-top:1px solid var(--line);
}

/* ============  ACCESSIBILITY FOCUS  ============ */
:focus-visible{outline: none; box-shadow: var(--focus)}
/* Utility hide */
.hidden{display:none !important}
</style>
</head>
<body>

<!-- ============ AGE GATE ============ -->
<div id="ageGate" class="gate-overlay" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
  <div class="gate" id="gate3D">
    <div class="door left"></div>
    <div class="door right"></div>
    <div class="gate-sign">
      <div class="gate-card">
        <h1 id="gateTitle">Enter if you are 18+</h1>
        <p>This gallery presents tasteful, artistic nudity for adults. By entering you certify that you are at least 18 years old (or the age of majority in your jurisdiction) and consent to view such content.</p>
        <div class="actions">
          <button id="enterBtn" class="btn primary" aria-label="Enter site">Enter</button>
          <a class="btn" href="https://www.google.com" aria-label="Leave site">Leave</a>
        </div>
        <label class="remember"><input id="rememberAge" type="checkbox" /> Remember for 30 days</label>
      </div>
    </div>
  </div>
</div>

<!-- ============ SITE ============ -->
<div id="app" class="site-root">
  <header>
    <div class="header-inner">
      <div class="brand" aria-label="Site brand">
        <div class="logo">Eros Noir</div>
        <div class="tag">Tasteful Erotic Art</div>
      </div>
      <div class="tools">
        <input id="search" type="search" placeholder="Search titles…" aria-label="Search" />
        <select id="sort" aria-label="Sort">
          <option value="name-asc">Name A–Z</option>
          <option value="name-desc">Name Z–A</option>
          <option value="fav-first">Favorites first</option>
        </select>
        <select id="theme" aria-label="Theme">
          <option value="auto">Auto</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
        <select id="density" class="density" aria-label="Grid density">
          <option value="auto">Auto</option>
          <option value="dense-0">Compact</option>
          <option value="dense-1">Comfort</option>
          <option value="dense-2">Spacious</option>
        </select>
      </div>
    </div>
    <div class="controls" id="controls">
      <div class="chips" id="chipBar" role="toolbar" aria-label="Categories"></div>
      <div class="count" id="count">0 photos</div>
    </div>
  </header>

  <main id="main">
    <div id="gallery" class="gallery" aria-live="polite" aria-busy="true"></div>
  </main>

  <footer>
    © <span id="year"></span> Eros Noir. All models and content are intended for adult audiences (18+). No tracking, no cookies beyond preferences and favorites (stored locally on your device).
  </footer>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" aria-modal="true" role="dialog" aria-label="Image viewer">
    <div class="viewer" id="viewer" tabindex="-1">
      <button class="lb-btn lb-close" id="lbClose" aria-label="Close">
        ✕
      </button>
      <button class="lb-arrow left" id="lbPrev" aria-label="Previous">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
      </button>
      <button class="lb-arrow right" id="lbNext" aria-label="Next">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 6l6 6-6 6"/></svg>
      </button>
      <img id="lbImg" alt="" />
    </div>
    <div class="lb-controls">
      <button class="lb-btn" id="lbFullscreen" aria-label="Toggle fullscreen">⛶ Fullscreen</button>
      <button class="lb-btn" id="lbPlay" aria-label="Play slideshow">▶︎ Slideshow</button>
      <button class="lb-btn" id="lbFav" aria-label="Toggle favorite">♡ Favorite</button>
      <a class="lb-btn" id="lbDownload" download aria-label="Download">↓ Download</a>
      <div class="lb-info" id="lbInfo"></div>
    </div>
  </div>
</div>

<script>
/* ===========================================================
   Eros Noir — Single-file, Apple-style GitHub Pages gallery
   HOW TO USE:
   1) Create a public repo and enable GitHub Pages.
   2) Put this file at repo root.
   3) Create /gallery and drop images (JPG/PNG/WebP/AVIF/GIF).
      Optional: subfolders (e.g., /gallery/BlackAndWhite).
   4) Commit. The page auto-lists from GitHub API.
   5) If not hosted on GitHub Pages, set CONFIG.source='static'
      and list images in CONFIG.staticImages.
   =========================================================== */

const CONFIG = {
  /* 'github' | 'static' — leave 'github' to auto-discover in a GitHub Pages repo */
  source: 'github',
  github: {
    owner: '',           // optional override; if blank we attempt to infer
    repo: '',            // optional override; if blank we attempt to infer
    branch: 'main',      // or 'master'
    path: 'gallery'      // folder that contains your images + subfolders
  },
  allowedExt: ['.jpg','.jpeg','.png','.webp','.avif','.gif'],
  slideMs: 3800
};

const state = {
  images: [],     // {src, name, path, folder, fav}
  filtered: [],
  folders: new Set(),
  current: -1,
  playing: false,
  favorites: new Set(JSON.parse(localStorage.getItem('en:favorites') || '[]')),
  theme: localStorage.getItem('en:theme') || 'auto'
};

const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const galleryEl = $('#gallery');
const chipBar = $('#chipBar');
const countEl = $('#count');
const searchEl = $('#search');
const sortEl = $('#sort');
const themeEl = $('#theme');
const densityEl = $('#density');
const yearEl = $('#year');
const appRoot = $('#app');
yearEl.textContent = new Date().getFullYear();

function setTheme(mode){
  state.theme = mode;
  localStorage.setItem('en:theme', mode);
  if(mode === 'dark') document.documentElement.style.colorScheme = 'dark';
  else if(mode === 'light') document.documentElement.style.colorScheme = 'light';
  else document.documentElement.style.colorScheme = '';
}
themeEl.value = state.theme; setTheme(state.theme);
themeEl.addEventListener('change', e => setTheme(e.target.value));
densityEl.addEventListener('change', e => {
  document.body.classList.remove('dense-0','dense-1','dense-2');
  if(e.target.value !== 'auto') document.body.classList.add(e.target.value);
});

/* ---------- Age Gate ---------- */
(function ageGate(){
  const key='en:age'; const overlay = $('#ageGate');
  const enterBtn = $('#enterBtn'); const remember = $('#rememberAge');
  const gate3D = $('#gate3D');
  const remembered = localStorage.getItem(key);
  if(remembered && Number(remembered) > Date.now()){
    overlay.remove(); appRoot.classList.add('ready'); return;
  }
  function openGate(){
    gate3D.classList.add('open');
    setTimeout(()=>{ overlay.remove(); appRoot.classList.add('ready') }, 1200);
  }
  enterBtn.addEventListener('click', ()=>{
    if(remember.checked){
      // remember for 30 days
      const until = Date.now() + 1000*60*60*24*30;
      localStorage.setItem(key, String(until));
    }
    openGate();
  }, {once:true});
})();

/* ---------- Repo inference ---------- */
function inferRepo(){
  const gh = CONFIG.github;
  if(gh.owner && gh.repo) return {owner:gh.owner, repo:gh.repo};
  const host = location.hostname; // e.g., user.github.io
  const path = location.pathname.replace(/^\/+|\/+$/g,'');
  let owner = gh.owner, repo = gh.repo;
  if(!owner && host.endsWith('.github.io')){
    owner = host.split('.github.io')[0];
  }
  if(!repo){
    // project page => first path segment; user page => owner.github.io
    const firstSeg = path.split('/')[0];
    repo = firstSeg || `${owner}.github.io`;
  }
  return {owner, repo};
}

/* ---------- Data source loaders ---------- */
async function loadFromGitHub(){
  const {owner, repo} = inferRepo();
  const branch = CONFIG.github.branch;
  const base = `https://api.github.com/repos/${owner}/${repo}/contents/${CONFIG.github.path}?ref=${encodeURIComponent(branch)}`;

  // fetch directory listing (files + subfolders)
  const root = await fetchJSON(base);
  if(!Array.isArray(root)) throw new Error('Invalid GitHub API response');

  const folders = root.filter(x => x.type === 'dir').map(x => x.name);
  folders.forEach(f => state.folders.add(f));

  // queue of file promises
  const fileItems = root.filter(x => x.type === 'file');
  const subfolderFetches = folders.map(name =>
    fetchJSON(`https://api.github.com/repos/${owner}/${repo}/contents/${CONFIG.github.path}/${encodeURIComponent(name)}?ref=${encodeURIComponent(branch)}`)
      .then(list => list.filter(x => x.type === 'file').map(x => ({...x, _folder: name})))
      .catch(()=>[]) // non-fatal
  );

  const results = [
    fileItems.map(x => ({...x, _folder: ''})),
    ...(await Promise.all(subfolderFetches))
  ].flat();

  // map to image entries
  const allowed = new Set(CONFIG.allowedExt);
  const images = results
    .filter(x => hasAllowedExt(x.name, allowed))
    .map(x => ({
      name: toTitle(x.name),
      path: `${CONFIG.github.path}${x._folder?'/'+x._folder:''}/${x.name}`,
      folder: x._folder || 'All',
      src: toRaw(owner, repo, branch, `${CONFIG.github.path}${x._folder?'/'+x._folder:''}/${encodeURIComponent(x.name)}`),
      fav: state.favorites.has(`${CONFIG.github.path}/${x._folder}/${x.name}`)
    }));

  // ensure "All" category is present
  state.folders.add('All');
  return images;
}

function hasAllowedExt(name, allowed){
  const n = name.toLowerCase();
  for(const ext of allowed){ if(n.endsWith(ext)) return true; }
  return false;
}
function toRaw(owner, repo, branch, path){
  return `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`;
}
async function fetchJSON(url){
  const res = await fetch(url, {headers:{'Accept':'application/vnd.github+json'}});
  if(!res.ok) throw new Error('GitHub API error');
  return res.json();
}

async function loadFromStatic(){
  // Manually list your images if not on GitHub Pages.
  // Example:
  // CONFIG.staticImages = ["gallery/01.jpg","gallery/02.jpg","gallery/sub/03.jpg"];
  const items = (CONFIG.staticImages || []).map(p => ({
    name: toTitle(p.split('/').pop()),
    path: p,
    folder: folderFromPath(p),
    src: p,
    fav: state.favorites.has(p)
  }));
  items.forEach(it => state.folders.add(it.folder || 'All'));
  state.folders.add('All');
  return items;
}
function folderFromPath(p){
  const parts = p.split('/');
  if(parts.length <= 2) return 'All';
  return parts.slice(1, parts.length-1).join('/');
}
function toTitle(fileName){
  return (fileName||'')
    .replace(/\.[a-z0-9]+$/i,'')
    .replace(/[-_]+/g,' ')
    .replace(/\s+/g,' ')
    .replace(/\b\w/g, s => s.toUpperCase());
}

/* ---------- Renderers ---------- */
function renderChips(){
  chipBar.innerHTML = '';
  const folders = Array.from(state.folders).sort((a,b)=>a.localeCompare(b));
  const allFirst = ['All', ...folders.filter(f => f!=='All')];
  allFirst.forEach((name,i)=>{
    const btn = document.createElement('button');
    btn.className='chip'; btn.type='button'; btn.textContent=name;
    btn.setAttribute('aria-pressed', name==='All' ? 'true':'false');
    btn.addEventListener('click', ()=>{
      // toggle selected
      $$('.chip').forEach(c=>c.setAttribute('aria-pressed','false'));
      btn.setAttribute('aria-pressed','true');
      filterAndRender();
    });
    chipBar.appendChild(btn);
  });
}
function activeFolder(){
  const active = $$('.chip').find(c => c.getAttribute('aria-pressed')==='true');
  return active ? active.textContent : 'All';
}

function filterAndRender(){
  const query = (searchEl.value||'').trim().toLowerCase();
  const folder = activeFolder();
  const favFirst = sortEl.value === 'fav-first';

  let items = state.images.filter(x=>{
    const matchesFolder = folder==='All' ? true : x.folder === folder;
    const matchesSearch = !query ? true : (x.name.toLowerCase().includes(query) || x.folder.toLowerCase().includes(query));
    return matchesFolder && matchesSearch;
  });

  // sorting
  if(sortEl.value === 'name-asc') items.sort((a,b)=>a.name.localeCompare(b.name));
  else if(sortEl.value === 'name-desc') items.sort((a,b)=>b.name.localeCompare(a.name));
  else if(favFirst){
    items.sort((a,b)=>{
      const A = state.favorites.has(a.path), B = state.favorites.has(b.path);
      if(A && !B) return -1; if(!A && B) return 1;
      return a.name.localeCompare(b.name);
    });
  }

  state.filtered = items;
  countEl.textContent = `${items.length} photo${items.length===1?'':'s'}`;
  renderGallery(items);
}

function renderGallery(items){
  galleryEl.setAttribute('aria-busy','true');
  galleryEl.innerHTML = '';
  const frag = document.createDocumentFragment();
  for(const [i,item] of items.entries()){
    const fig = document.createElement('figure');
    const img = document.createElement('img');
    img.loading='lazy';
    img.decoding='async';
    img.alt = item.name;
    img.src = item.src;
    img.addEventListener('click', ()=>openLightboxByIndex(i));
    const cap = document.createElement('figcaption');
    const title = document.createElement('span'); title.textContent = item.name;
    const actions = document.createElement('span'); actions.className='card-actions';

    const btnOpen = document.createElement('a'); btnOpen.className='icon-link'; btnOpen.href=item.src; btnOpen.target='_blank'; btnOpen.title='Open original';
    btnOpen.innerHTML = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 3h7v7"/><path d="M21 3l-9 9"/><path d="M5 12v7a2 2 0 0 0 2 2h7"/></svg>';

    const btnFav = document.createElement('button'); btnFav.className='icon-link'; btnFav.type='button'; btnFav.title='Favorite';
    const isFav = state.favorites.has(item.path);
    btnFav.innerHTML = isFav ? '❤' : '♡';
    btnFav.addEventListener('click', (e)=>{
      e.stopPropagation();
      toggleFavorite(item.path);
      btnFav.innerHTML = state.favorites.has(item.path) ? '❤' : '♡';
      if(sortEl.value==='fav-first') filterAndRender();
    });

    actions.append(btnOpen, btnFav);
    cap.append(title, actions);
    fig.append(img, cap);
    frag.append(fig);
  }
  galleryEl.append(frag);
  revealObserve();
  galleryEl.removeAttribute('aria-busy');
}

function revealObserve(){
  const obs = new IntersectionObserver((entries, ob)=>{
    for(const e of entries){
      if(e.isIntersecting){ e.target.classList.add('visible'); ob.unobserve(e.target); }
    }
  }, {rootMargin:'80px 0px'});
  $$('#gallery figure').forEach(el=>obs.observe(el));
}

/* ---------- Favorites ---------- */
function toggleFavorite(path){
  if(state.favorites.has(path)) state.favorites.delete(path);
  else state.favorites.add(path);
  localStorage.setItem('en:favorites', JSON.stringify(Array.from(state.favorites)));
}

/* ---------- Lightbox ---------- */
const lb = $('#lightbox'), lbImg = $('#lbImg'), lbInfo = $('#lbInfo');
const lbClose = $('#lbClose'), lbPrev = $('#lbPrev'), lbNext = $('#lbNext');
const lbPlay = $('#lbPlay'), lbFs = $('#lbFullscreen'), lbDownload = $('#lbDownload');
let slideTimer = null;

function openLightboxByIndex(i){
  state.current = i;
  lb.classList.add('open');
  loadCurrent();
  $('#viewer').focus({preventScroll:true});
}
function closeLightbox(){
  stopSlide();
  lb.classList.remove('open');
  state.current = -1;
}
function loadCurrent(){
  const item = state.filtered[state.current];
  if(!item) return;
  lbImg.classList.remove('ready');
  lbImg.src = ''; // reset for transition
  const img = new Image();
  img.onload = ()=>{
    lbImg.src = img.src;
    lbImg.alt = item.name;
    lbImg.classList.add('ready');
  };
  img.src = item.src;
  lbInfo.textContent = `${item.name}  —  ${state.current+1} / ${state.filtered.length}`;
  lbDownload.href = item.src;
  $('#lbFav').textContent = state.favorites.has(item.path) ? '❤ Favorite' : '♡ Favorite';
  // Preload neighbors
  preloadNeighbor(state.current+1);
  preloadNeighbor(state.current-1);
}
function preloadNeighbor(idx){
  const it = state.filtered[(idx+state.filtered.length)%state.filtered.length];
  if(!it) return;
  const im = new Image(); im.src = it.src;
}
function prev(){ state.current = (state.current - 1 + state.filtered.length) % state.filtered.length; loadCurrent(); }
function next(){ state.current = (state.current + 1) % state.filtered.length; loadCurrent(); }

function toggleSlide(){
  if(state.playing) stopSlide(); else startSlide();
}
function startSlide(){
  state.playing = true;
  lbPlay.textContent = '❚❚ Pause';
  slideTimer = setInterval(next, CONFIG.slideMs);
}
function stopSlide(){
  state.playing = false;
  lbPlay.textContent = '▶︎ Slideshow';
  if(slideTimer) clearInterval(slideTimer);
  slideTimer = null;
}

function toggleFullscreen(){
  const el = $('#lightbox');
  if(!document.fullscreenElement) el.requestFullscreen?.();
  else document.exitFullscreen?.();
}

lbClose.addEventListener('click', closeLightbox);
lbPrev.addEventListener('click', prev);
lbNext.addEventListener('click', next);
lbPlay.addEventListener('click', toggleSlide);
lbFs.addEventListener('click', toggleFullscreen);
$('#lbFav').addEventListener('click', ()=>{
  const item = state.filtered[state.current]; if(!item) return;
  toggleFavorite(item.path);
  $('#lbFav').textContent = state.favorites.has(item.path) ? '❤ Favorite' : '♡ Favorite';
});

/* Keyboard & swipe */
document.addEventListener('keydown', (e)=>{
  if(!lb.classList.contains('open')) return;
  if(e.key==='Escape') closeLightbox();
  else if(e.key==='ArrowLeft') prev();
  else if(e.key==='ArrowRight') next();
  else if(e.key===' ') { e.preventDefault(); toggleSlide(); }
});
let touchX=0;
lb.addEventListener('touchstart', e=>{ touchX = e.touches[0].clientX; }, {passive:true});
lb.addEventListener('touchend', e=>{
  const dx = e.changedTouches[0].clientX - touchX;
  if(Math.abs(dx) > 40) (dx>0?prev:next)();
});

/* ---------- Controls ---------- */
searchEl.addEventListener('input', filterAndRender);
sortEl.addEventListener('change', filterAndRender);

/* ---------- Boot ---------- */
(async function boot(){
  try{
    state.images = CONFIG.source==='github' ? await loadFromGitHub() : await loadFromStatic();
  }catch(err){
    console.warn('GitHub API failed. Falling back to static list.', err);
    state.images = await loadFromStatic();
  }
  renderChips();
  filterAndRender();
  // Register a minimal offline SW (optional)
  try{
    if('serviceWorker' in navigator){
      const swCode = `
        self.addEventListener('install', e=>self.skipWaiting());
        self.addEventListener('activate', e=>self.clients.claim());
        self.addEventListener('fetch', e=>{
          const u = new URL(e.request.url);
          if(u.origin===location.origin || u.hostname==='raw.githubusercontent.com'){
            e.respondWith(caches.open('en-cache-v1').then(async c=>{
              const r = await c.match(e.request);
              if(r) return r;
              const f = await fetch(e.request, {mode:'cors'});
              if(f.ok) c.put(e.request, f.clone());
              return f;
            }));
          }
        });
      `;
      const blob = new Blob([swCode], {type:'text/javascript'});
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl);
    }
  }catch(e){ /* non-fatal */ }
})();

/* ---------- Helpers ---------- */
</script>

</body>
</html>
